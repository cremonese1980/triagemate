# Phase 9.1 ‚Äî PostgreSQL Runtime + Profiles

---

# State Marker ‚Äî 9.1
phase: 9.1
current_stage: D        # A=Design | B=Change Design | C=Implementation | D=Verification | E=Done

applied_changes:
- TM-9.1

stabilized_changes:
- TM-9.1

pending_verification:
- docker full restart test (infra down/up)

tests_status:
unit: passing
integration: n/a (DB tests not yet introduced)
manual: passing (IDE + Docker)

dod_status: almost_met
last_known_green_commit: current_branch_head
frp_active: false

**Phase Lineage:**
```
v0.8.1 (Phase 8.1) ‚Üí Phase 9.1 (PostgreSQL) ‚Üí Phase 9.2 (Durable Idempotency)
```

---

## üÖê Design Freeze

### Problem Statement
Durable idempotency ([ADR-005](./adr/ADR-005-durable-idempotency.md)) requires persistent database infrastructure. Current in-memory implementation is not production-safe.

### Solution
Introduce **PostgreSQL runtime environment** for development and CI:
- Docker Compose service for local development
- Profile-based datasource configuration
- Health indicator integration
- Testcontainers for integration tests

### Explicit Scope

| In Scope ‚úÖ | Out of Scope ‚ùå |
|-------------|-----------------|
| PostgreSQL Docker service | Business domain tables |
| Spring datasource profiles | Idempotency table (Phase 9.2) |
| Health indicator wiring | JPA entities |
| Testcontainers integration | Flyway migrations |
| Connection pooling config | Production deployment config |

### Technology Decision
**PostgreSQL 16** chosen for:
- Enterprise standard (production parity)
- Excellent Spring Boot support
- Native Testcontainers support
- ACID compliance for idempotency guarantees

**Alternatives considered:**
- H2 (rejected: different SQL dialect, not prod-like)
- MySQL (rejected: team PostgreSQL expertise)

---

## üÖë Implementation Tasks

### Task 9.1.a ‚Äî PostgreSQL Docker Runtime

**Deliverable:** `docker-compose.yml` PostgreSQL service

```yaml
services:
  postgres:
    image: postgres:16-alpine
    container_name: triagemate-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: triagemate
      POSTGRES_USER: triagemate_dev
      POSTGRES_PASSWORD: dev_password_change_in_prod
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U triagemate_dev"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

**Acceptance:**
- `docker compose up -d postgres` starts successfully
- Port 5432 exposed on localhost
- Data persists across container restarts (dev only)

---

### Task 9.1.b ‚Äî Spring Datasource Profiles

**Deliverable:** Profile-specific datasource configurations

#### `application-dev.yml`
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/triagemate
    username: triagemate_dev
    password: dev_password_change_in_prod
    driver-class-name: org.postgresql.Driver
  jpa:
    hibernate:
      ddl-auto: validate  # Never auto-create in dev
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.PostgreSQLDialect
```

#### `application-test.yml`
```yaml
spring:
  datasource:
    # Overridden by @DynamicPropertySource in tests
    url: jdbc:tc:postgresql:16-alpine:///triagemate
    driver-class-name: org.testcontainers.jdbc.ContainerDatabaseDriver
  jpa:
    hibernate:
      ddl-auto: create-drop  # OK for test isolation
    show-sql: false
```

**Acceptance:**
- No profile hacks like `!test` used
- Dev profile connects to local Docker PostgreSQL
- Test profile uses Testcontainers automatically
- Clear separation of concerns

---

### Task 9.1.c ‚Äî Actuator Health Integration

**Deliverable:** Database health indicator configuration

```yaml
# application.yml (base config)
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: always
  health:
    db:
      enabled: true
```

**Expected Health Response:**
```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "validationQuery": "isValid()"
      }
    },
    "diskSpace": { "status": "UP" },
    "ping": { "status": "UP" }
  }
}
```

**Acceptance:**
- `/actuator/health` includes `db` component
- Application fails fast on startup if DB unavailable (dev profile)
- Clear error message guides troubleshooting

---

### Task 9.1.d ‚Äî Secrets Discipline

**Deliverable:** Security documentation and configuration

#### Credential Guidelines
```markdown
## Local Development
- Default credentials acceptable (clearly marked as dev-only)
- Never commit production credentials
- Use environment variables for sensitive overrides

## Environment Override Pattern
export SPRING_DATASOURCE_URL=jdbc:postgresql://prod-db:5432/triagemate
export SPRING_DATASOURCE_USERNAME=${PROD_DB_USER}
export SPRING_DATASOURCE_PASSWORD=${PROD_DB_PASSWORD}
```

#### `.gitignore` additions
```
# Local secrets (if needed)
application-local.yml
application-secrets.yml
.env.local
```

**Acceptance:**
- No real credentials in version control
- Clear documentation for environment-based overrides
- Dev defaults clearly marked as insecure

---

## üÖí Verification Plan

### Automated Verification

```bash
# CI must pass without local PostgreSQL
./mvnw clean verify

# Integration tests use Testcontainers
./mvnw test -Dtest=**/*IntegrationTest
```

**Expected Result:**
- All tests green
- Testcontainers downloads PostgreSQL image (first run)
- No manual setup required for CI

---

### Manual Verification Checklist

| Step | Command | Expected Result |
|------|---------|-----------------|
| 1 | `docker compose up -d postgres` | PostgreSQL starts, port 5432 exposed |
| 2 | `./mvnw spring-boot:run -Dspring-boot.run.profiles=dev` | App starts successfully |
| 3 | `curl http://localhost:8080/actuator/health` | Response includes `"db": {"status": "UP"}` |
| 4 | `docker compose down` | App fails fast with clear DB error |
| 5 | `docker compose up -d postgres && restart app` | App recovers and connects |

---

## üÖì Done Criteria

Phase 9.1 is **DONE** when:

- ‚úÖ PostgreSQL Docker service defined in `docker-compose.yml`
- ‚úÖ Profile-based datasource configuration working
- ‚úÖ `/actuator/health` shows DB health status
- ‚úÖ CI pipeline green (Testcontainers working)
- ‚úÖ No business logic changes introduced
- ‚úÖ `README.md` updated with:
  - PostgreSQL setup instructions
  - Profile activation guidance
  - Troubleshooting section
- ‚úÖ `phase9.md` updated with Phase 9.1 completion
- ‚úÖ Tag `v0.9.1` created and pushed

---

## üì¶ Dependencies

### Maven Dependencies to Add

```xml
<!-- PostgreSQL Driver -->
<dependency>
    <groupId>org.postgresql</groupId>
    <artifactId>postgresql</artifactId>
    <scope>runtime</scope>
</dependency>

<!-- Spring Boot Starter Data JPA -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>

<!-- Testcontainers (test scope) -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>postgresql</artifactId>
    <scope>test</scope>
</dependency>
```

---

## üîó Related Documentation

- [ADR-005: Durable Idempotency Strategy](./adr/ADR-005-durable-idempotency.md)
- [Phase 8.1: InMemory Idempotency](./Phase-8.1-InMemory-Idempotency.md)
- [Phase 9.2: Durable Idempotency Implementation](./Phase-9.2-Durable-Idempotency.md)
- [Structured Coding Process v3.0](./structured-coding-process-v3.md)

---

## ‚ö†Ô∏è Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|-----------|
| **Testcontainers slow CI** | Medium | Cache Docker images, use lightweight alpine variant |
| **Port 5432 already in use** | Low | Document conflict resolution, use `docker compose port` |
| **Credential leak** | High | Pre-commit hooks, secret scanning, clear docs |
| **Profile confusion** | Medium | Explicit profile activation in docs, fail-fast validation |

---

## üìù Implementation Checklist

### Phase A: Infrastructure Setup
- [ ] Add PostgreSQL service to `docker-compose.yml`
- [ ] Test local PostgreSQL startup
- [ ] Add Maven dependencies

### Phase B: Spring Configuration
- [ ] Create `application-dev.yml` with datasource config
- [ ] Create `application-test.yml` with Testcontainers config
- [ ] Wire actuator health indicator

### Phase C: Testing
- [ ] Verify Testcontainers integration tests
- [ ] Manual verification checklist
- [ ] CI pipeline validation

### Phase D: Documentation
- [ ] Update `README.md` with setup instructions
- [ ] Document environment variable overrides
- [ ] Add troubleshooting section
- [ ] Update `phase9.md`

### Phase E: Completion
- [ ] All tests green
- [ ] Code review approval
- [ ] Tag `v0.9.1` created

---

**Document Version:** 1.0  
**Last Updated:** 2026-02-19  
**Status:** Design phase complete, implementation ready to start