# ðŸš€ Phase 10.1 â€” Transactional Outbox Foundation

---

## ðŸ“Š STATE MARKER â€” PHASE 10.1
```yaml
Change ID: TM-10.1
Branch: feat/phase-10-transactional-outbox

Stage: A (Design & Schema Initialization)

Runtime:
  - Profile dev: NOT IMPLEMENTED
  - Profile docker: NOT IMPLEMENTED
  - Outbox table: CREATED
  - Publisher: NOT IMPLEMENTED

Implementation:
  - outbox_events table (V2 migration)
  - Status constraint (PENDING | PUBLISHED | FAILED)
  - Polling index (status, next_attempt_at)
  - Locking columns (lock_owner, locked_until)
  - Aggregate tracing index

Pending:
  - Orchestrator refactor (write outbox inside TX)
  - Remove direct Kafka publish from listener path
  - Implement OutboxPublisher component
  - Implement batch claim query (FOR UPDATE SKIP LOCKED)
  - Implement retry/backoff policy
  - Multi-instance safety verification
  - Integration tests (outbox end-to-end)
  - Docker manual validation
  - README update
  - ADR update
  - Tag v0.10.0

Integration status: NOT STARTED
CI status: NOT VERIFIED

Completion criteria: NOT MET
```
---
## Objective

Eliminate the crash window introduced by claim-first semantics in Phase 9.2 by implementing the **Transactional Outbox pattern**.

Ensure:
* No dual-write (DB + Kafka)
* Atomic persistence of business outcome + outbound event
* Reliable async publishing with retry
* Multi-instance safe publisher
* No message loss

---

## Architecture Overview

### Processing Flow (New)

1. Kafka listener receives message
2. Orchestrator service opens DB transaction
3. Insert into `processed_events` (claim)
4. Execute decision logic
5. Insert into `outbox_events` (PENDING)
6. **Commit transaction**
7. Async publisher polls and emits Kafka event
8. Mark outbox row as PUBLISHED

### Outbox Strategy

* Polling-based publisher (no CDC)
* Same service (`triagemate-triage`)
* Dedicated component: `OutboxPublisher`
* Locking via `FOR UPDATE SKIP LOCKED`
* Retry with backoff
* Status-driven state machine


---

## Next Steps

1. **Stage A**: Schema design complete âœ…
2. **Stage B**: Implement `OutboxPublisher` component
3. **Stage C**: Refactor orchestrator to write outbox entries
4. **Stage D**: Integration testing
5. **Stage E**: Docker validation & tagging