STATE_MARKER:

Phase: 8.1 — Kafka Deserialization Hardening
Progress: ~80%
Manual testing: Happy path OK
Remaining:
- Integrate ErrorHandlingDeserializer cleanly
- Verify malformed JSON behavior
- Validate offset semantics
  Next:
- Complete 8.1 verification
- Move to 8.2 (Retry / DLT / Backoff)




# PHASE 8.1 — Kafka Deserialization Hardening

## Context

During manual Kafka testing, the consumer crashed when receiving malformed JSON.
Root cause:

- JsonEOFException during value deserialization
- Wrapped in SerializationException
- Not handled by Spring Kafka error handler
- Consumer container stopped
- Partitions revoked
- Application effectively unstable

This revealed a structural weakness in the deserialization layer.

---

## Problem Statement

Spring Kafka by default:

- Uses JsonDeserializer directly
- Throws SerializationException on malformed payload
- Default error handler cannot process SerializationException
- Listener container stops

This is unacceptable for a production-grade event-driven system.

A single corrupted record must NOT:
- Stop the container
- Kill the consumer group
- Cause partition revocation cascade

---

## Objective

Make Kafka consumer deserialization:

- Safe
- Non-blocking
- Observable
- Recoverable

Without breaking the happy path.

---

## Scope

1. Introduce ErrorHandlingDeserializer for consumer
2. Ensure malformed messages do not stop container
3. Preserve correct behavior for valid events
4. Maintain deterministic routing logic
5. Keep profile separation intact

---

## Implementation

### Consumer config adjustment

Replace:

spring.kafka.consumer.value-deserializer:
org.springframework.kafka.support.serializer.JsonDeserializer

With:

org.springframework.kafka.support.serializer.ErrorHandlingDeserializer

And configure:

spring.kafka.consumer.properties.spring.deserializer.value.delegate.class:
org.springframework.kafka.support.serializer.JsonDeserializer

spring.kafka.consumer.properties.spring.json.trusted.packages:
com.triagemate.contracts.*

spring.kafka.consumer.properties.spring.json.value.default.type:
com.triagemate.contracts.events.EventEnvelope

spring.kafka.consumer.properties.spring.json.use.type.headers:
false

---

## Expected Behavior

### Valid JSON
- Deserializes correctly
- Routed
- Offset committed
- Producer publishes downstream event
- Container stable

### Malformed JSON
- Deserialization error captured
- Listener not invoked
- Container remains alive
- Offset skipped or handled
- System continues processing next records

---

## Out of Scope

- DLT topic implementation
- Retry/backoff policies
- Poison-pill replay strategy
- Observability improvements

These belong to Phase 8.2.

---

## Definition of Done

- [ ] Happy path still works (manual verified)
- [ ] Malformed JSON no longer stops container
- [ ] Consumer remains subscribed after error
- [ ] No partition revocation cascade
- [ ] No uncontrolled shutdown
- [ ] Logs clearly indicate deserialization failure
- [ ] No impact on existing deterministic routing logic
- [ ] No profile pollution (dev/test isolation preserved)

---

## Risks

- Silent skipping of invalid records
- Offset commit semantics must be verified

---

## Verification Steps

1. Run app with dev profile and Docker Kafka
2. Send valid EventEnvelope JSON
3. Verify ACCEPT decision logged
4. Send truncated JSON
5. Verify:
    - Error logged
    - Container alive
    - Next valid message processed correctly
