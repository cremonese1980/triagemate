# Phase 8.2 â€“ Durable Idempotency & Production Readiness

---

## ğŸ“Š STATE

```yaml
Status:       NOT_STARTED
Owner:        Gabriele
Branch:       feat/phase-8.2-durable-idempotency
Depends On:   v0.8.1
Last Updated: 2026-02-19
Target Tag:   v0.8.2
```

**Phase Dependencies:**
- âœ… Phase 8.1 (InMemory idempotency) â€“ `COMPLETED`
- ğŸ”„ Phase 8.2 (Durable idempotency) â€“ `NOT_STARTED`

---

## ğŸ¯ JIRA STORY

### Title
**Phase 8.2 â€“ Replace InMemory idempotency with durable strategy**

### Context
Phase 8.1 introduced idempotent Kafka consumer behavior using `InMemoryEventIdIdempotencyGuard`.

**Current Limitations (Production Blockers):**
- âŒ **State loss on restart** â€“ Processed event IDs are lost when service restarts
- âŒ **Horizontal scaling breaks guarantees** â€“ Multiple instances don't share idempotency state
- âŒ **Post-deployment duplicates** â€“ Risk of reprocessing after deployments

**Phase 8.2 Solution:**  
Introduce a **durable idempotency mechanism** that persists processed event IDs across restarts and instances.

---

## ğŸ¯ Goal

Provide **crash-safe, horizontally-scalable idempotency** without changing external behavior or breaking existing integration tests.

---

## âœ… Acceptance Criteria

| ID | Criterion | Verification Method |
|----|-----------|---------------------|
| **AC1** | Duplicate `eventId` never produces duplicate decision | Integration test |
| **AC2** | Service restart does NOT reprocess already-processed events | Restart scenario test |
| **AC3** | Multiple instances do not break idempotency guarantees | Multi-instance test |
| **AC4** | No regression on existing integration tests | CI pipeline |
| **AC5** | New integration test validates restart scenario | New test case |
| **AC6** | Latency impact measured and documented | Benchmark report |

---

## ğŸ”§ Technical Scope

### 1. Introduce `DurableEventIdIdempotencyGuard`

**Implementation Options** (decision required):

| Option | Pros | Cons | Complexity |
|--------|------|------|------------|
| **JDBC + unique constraint** | Simple, transactional, no new deps | DB I/O overhead | Low |
| **Redis SETNX** | Fast, distributed-friendly | External dependency, network latency | Medium |
| **Kafka compacted topic** | Native Kafka, no external store | Complex offset management, eventual consistency | High |
| **Outbox-style table** | Transactional safety, audit trail | Requires background worker | Medium |

**Decision Point:**  
Implementation strategy must be explicitly chosen and documented before development starts.

---

### 2. Extract Idempotency Port

**Hexagonal Architecture Pattern:**

```
Port:
  â””â”€ EventIdIdempotencyGuard (interface)

Adapters:
  â”œâ”€ InMemoryEventIdIdempotencyGuard (dev/test)
  â””â”€ DurableEventIdIdempotencyGuard (prod)
```

**Profile Configuration:**
- `spring.profiles.active=dev` â†’ InMemory
- `spring.profiles.active=prod` â†’ Durable

---

### 3. Persistence Layer

**If JDBC option chosen:**

#### Flyway Migration
```sql
-- V8.2.0__Create_processed_events_table.sql
CREATE TABLE processed_events (
    event_id VARCHAR(255) PRIMARY KEY,
    processed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    consumer_group VARCHAR(100) NOT NULL
);

CREATE INDEX idx_processed_at ON processed_events(processed_at);
```

#### Retention Strategy
- **Option A:** TTL-based cleanup (e.g., 7 days)
- **Option B:** Size-based cleanup (keep last N events)
- **Decision:** Document chosen approach

---

### 4. Concurrency Safety

**Guarantees Required:**
- âœ… Exactly-once side effect execution
- âœ… Safe under concurrent consumer threads
- âœ… No race conditions on duplicate detection

**Implementation Strategy:**
- Use `INSERT ... ON CONFLICT DO NOTHING` (PostgreSQL)
- Or `INSERT IGNORE` (MySQL)
- Or pessimistic locking with `SELECT FOR UPDATE`

---

### 5. Tests

#### Integration Tests
- âœ… Duplicate still blocked (existing test, must pass)
- âœ… **NEW:** Restart scenario test
- âœ… **NEW:** Parallel consumer simulation (if feasible)

#### Unit Tests
- âœ… Durable guard behavior under normal conditions
- âœ… Conflict scenario handling
- âœ… Exception handling (DB unavailable)

#### Test Matrix

| Test Case | Scope | Expected Result |
|-----------|-------|-----------------|
| Duplicate detection (in-memory) | Unit | Duplicate rejected |
| Duplicate detection (durable) | Integration | Duplicate rejected |
| Service restart + replay | Integration | No reprocessing |
| Concurrent writes | Integration | One wins, others skip |
| DB unavailable | Unit | Graceful degradation or fail-fast |

---

## ğŸš« Non-Goals

The following are **explicitly out of scope** for Phase 8.2:

- âŒ Outbox pattern implementation
- âŒ DLT redesign or routing changes
- âŒ Circuit breaker for downstream services
- âŒ Full distributed transaction support (Saga pattern)

---

## ğŸ“Š Observability

### Metrics
```yaml
idempotency.duplicate.count:
  type: counter
  tags: [consumer_group, topic]
  description: Number of duplicate eventIds detected

idempotency.persist.latency:
  type: histogram
  tags: [operation]
  description: Latency of idempotency guard operations (ms)

idempotency.db.errors:
  type: counter
  tags: [error_type]
  description: Database errors during idempotency checks
```

### Structured Logging
```json
{
  "event": "idempotency.first_process",
  "event_id": "evt-12345",
  "consumer_group": "triage-mate",
  "timestamp": "2026-02-19T10:30:00Z"
}

{
  "event": "idempotency.duplicate_blocked",
  "event_id": "evt-12345",
  "consumer_group": "triage-mate",
  "original_processed_at": "2026-02-19T10:30:00Z",
  "timestamp": "2026-02-19T10:31:00Z"
}
```

---

## âš ï¸ Risks

| Risk | Impact | Mitigation |
|------|--------|-----------|
| **Latency regression** | High | Benchmark before/after, set SLA threshold |
| **DB contention** | Medium | Use connection pooling, optimize indexes |
| **Transactional boundary mistakes** | High | Code review, integration tests |
| **Storage growth** | Medium | Implement retention/cleanup strategy |

---

## ğŸ Exit Criteria

Phase 8.2 is complete when:

- âœ… All existing tests remain green
- âœ… Restart scenario validated in integration test
- âœ… Latency impact benchmarked and documented (< 10ms P95 acceptable)
- âœ… README updated with configuration instructions
- âœ… Flyway migration applied successfully
- âœ… Code review approved
- âœ… Tag `v0.8.2` created and pushed

---

## ğŸ“ Implementation Checklist

### Phase A: Design & Decision
- [ ] Choose persistence strategy (JDBC/Redis/Kafka)
- [ ] Document decision with rationale
- [ ] Design schema/data model
- [ ] Define retention strategy

### Phase B: Port Extraction
- [ ] Create `EventIdIdempotencyGuard` interface
- [ ] Refactor `InMemoryEventIdIdempotencyGuard` to implement port
- [ ] Update existing tests

### Phase C: Durable Implementation
- [ ] Implement `DurableEventIdIdempotencyGuard`
- [ ] Create Flyway migration (if JDBC)
- [ ] Add profile-based configuration

### Phase D: Testing
- [ ] Write unit tests for durable guard
- [ ] Write restart scenario integration test
- [ ] Write concurrent access test
- [ ] Verify no regression on existing tests

### Phase E: Observability & Documentation
- [ ] Add metrics
- [ ] Add structured logging
- [ ] Update README
- [ ] Benchmark latency
- [ ] Create tag `v0.8.2`

---

## ğŸ”— Related Documentation

- [Phase 8.1 Specification](./Phase-8.1-Idempotency.md)
- [Structured Coding Process v3.0](./structured-coding-process-v3.md)
- [Kafka Consumer Configuration](./kafka-consumer-config.md)
- [Hexagonal Architecture Guidelines](./hexagonal-architecture.md)

---

**Document Version:** 1.0  
**Last Reviewed:** 2026-02-19  
**Next Review:** After Phase 8.2 completion